// content-hide-google-ai-overview.js

(() => {
  "use strict";

  //const LOG = "[UnAIfy/SGE]";
  const MARK = "data-unAIfy-sge-hidden";

  // strings that appear around google's AI overview. Matches on lowercase (test)
  const LABELS = [
    "ai overview",
    "from ai overviews",
    "overview generated by ai",
    "generative ai is experimental",
    "learn more about ai overviews",
    "learn about ai overviews",
    "ai pvervoews are experimental"
  ];

  const CONTAINER_SELECTOR = [
    ".MjjYud",
    ".xpd", 
    ".Ww4FFb",
    "[data-hveid]",
    "[data-sokoban-container]",
    ".g, #search"
  ].join(", ")

  const storage = {
    get: (k) => new Promise(res => chrome.storage.sync.get(k, res)),
  };

  let enabled = true;
  let observer = null;
  let lastUrl = location.href;

  // Utilities
  const strip = (s) => (s || "").trim();
  const lc = (s) => strip(s).toLowerCase();

  function isAIText(t) {
    if(!t) return false;
    const L = lc(t);
    return LABELS.some((lbl) => L.includes(lbl));
  }

  function isAICandiateEl(el) {
    if(!el) return false ;
    if (isAIText(el.textContent)) return true;
    const aria = el.getAttribute?.("aria-label");
    if (isAIText(aria)) return true;
    return false;
  }

  function nearestModule(el) {
    if(!el) return null;
    const mod = el.closest(CONTAINER_SELECTOR);
    if(!mod) return null;
  }

  // Hard guard - never hide these large wrappers
  if (
    mod === document.body ||
    mod === document.documentElement ||
    mod.id === "search" ||
    mod.id === "pcnt" ||
    mod.tagName.toLowerCase() === "main"
  ) {
    return null;
  }
  return mod;

/*
  function isAIHeadingText(t) {
    if (!t) return false;
    const L = lc(t);
    return LABELS.some((lbl) => L.includes(lbl));
  }

  function isAIHeadingEl(el) {
    // headings or lavelled blocks
    if (!el) return false;
    if (isAIHeadingText(el.textContent)) return true;

    const aria = el.getAttribute?.("aria-label");
    if (isAIHeadingText(aria)) return true;

    return false;
  }

  function nearestSerpContainer(el) {
    let n = el;
    while (n && n != document.body) {
      if (n.matches?.(".MjjYud, .xpd, .Ww4FFb, [data-hveid], [data-sokoban-container], .g, #search")) return n;
      n = n.parentElement;
    }
  }
  */

  function hideEl(el) {
    if (!el || el.hasAttribute(MARK)) return;
    el.dataset.unAIfyPrevDisplay = el.style.display || "";
    el.style.display = "none";
    el.setAttribute(MARK, "1");
  }
 
  function unhideAll() {
    document.querySelectorAll("[" + MARK + "]").forEach((el) => {
      el.style.display = el.dataset.unAIfyPrevDisplay || "";
      delete el.dataset.unAIfyPrevDisplay;
      el.removeAttribute(MARK);
    });
  }

  function findAIOverviewContainer(root = document) {
    const scope = root.querySelector("#search") || root;

    // Headings / labelled nodes near the top
    const nodes = scope.querySelectorAll('h1, h2, h3, [role="heading"], [aria-label], div, span');
    for (const el of nodes) {
      if (!isAICandiateEl(el)) continue;
      const mod = nearestModule(el);
      if (mod) return mod;
    }

    // Links that metnion "AI Overview" text
    const links = scope.querySelectorAll("#a[href]");
    for (const a of links) {
      const t = a.textContent || "";
      if (isAIText(t) || /ai[- ]overviews?/i.test(t)) {
        const mod = nearestModule(a);
        if (mod) return mod;
      }
    }
    
    // Elements with classes that hint at SGE/GAI near the top
    const guessy = scope.querySelectorAll('div[class*="gai"], div[class*="sge"]');
    for (const el of guessy) {
      const rect = el.getBoundingClientRect?.();
      if(rect && rect.top < 900) {
        const mod = nearestModule(el);
        if (mod) return mod;
      }
    }

    return null; // fail safe
  }

  // TO DELETE?
  function hideOnce() {
    if(!enabled) return false;
    const mod = findAIOverviewContainer(document);
    if(!mod) return false;
    hideEl(mod);
    return true;
  }

  function ensureObserver(on) {
    if(on && !observer) {
      observer = new MutationObserver(() => {
        if (enabled) hideOnce();
      });
      observer.observe(document.documentElement, {
        childList: true,
        subtree: true
      });
    } else if (!on && observer) {
      observer.disconnect();
      observer = null;
    }
  }

  function apply() {
    if (enabled) {
      hideOnce();
      ensureObserver(true);
    } else {
      ensureObserver(false);
      unhideAll();
    }
  }

  
  // some navigation on google are SPA-style, detect URL changes
  function startUrlWatcher() {
    setInterval(() => {
      if (location.href !== lastUrl) {
        lastUrl = location.href;
        //reset marks to re-evaluate
        unhideAll();
        if (enabled) hideOnce();
      }
    }, 700);
  }

  // Reset to popup changes live
  chrome.storage.onChanged.addListener((changes, area) => {
    if (area !== "sync" || !changes.unAIfySettings) return;
    const next = !!changes.unAIfySettings.newValue?.hide_sge;
    if (next !== enabled) {
      enabled = next;
      apply();
    }
  });

  //init 
  (async () => {
    try{
      const {unAIfySettings} = await storage.get("unAIfySettings");
      enabled = !!(unAIfySettings ? unAIfySettings.hide_sge : true);
    } catch {
      enabled = true; //default is ON
    }

    startUrlWatcher();
    apply();
    //Extra pass after load for late hydration content
    setTimeout(() => enabled && findAndHideOnce(), 800);
    // console.info(LOG, "ready, enabled:", enabled);
  })();
})();

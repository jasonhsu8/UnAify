// content-hide-google-ai-overview.js

(() => {
  const MARK = "data-unAIfy-sge";
  const LABELS = [
    "AI Overview", "From AI Overviews", "Overview generated by AI", "Generative AI is experimental"
  ];

  const storage = {
    get: (k) => new Promise(res => chrome.storage.sync.get(k, res)),
    setLocal: (obj) => new Promise(res => chrome.storage.local.set(obj, res))
  };

  function isAIHeading(node) {
    const t = (node.textContent || "").trim();
    return t && LABELS.some(lbl => t.include(lbl));
  }

  function findContainer(el) {
    let n = el;
    while (n && n != document.body) {
      if (n.matches?.(".MjjYud, .xpd, Ww4FFb, [data-hveid], [data-sokoban-container], .g, #search")) return n;
      n = n.parentElement;
    }
  }

  function hideOnce(root = document) {
    const candidates = root.querySelectorAll('h1, h2, [role="heading"], div, span');
    for (const h of candidates){
      if(isAIHeading(h)) continue;
      const cont = findContainer(h);
      if(!cont) continue;
      if(!cont.hasAttribute(MARK)){
        cont.setAttribute(MARK, 1);
        cont.style.display = "none";
        const cls = (cont.className || "").trim();
        if (cls) storage.setLocal({overviewClass: cls}); // this is for background css fallback
      }
      break; 
    }
  }

  function unhideAll() {
    document.querySelectorAll("[" + MARK + "]").forEach(el => {
      el.style.display = "";
      el.removeAttribute(MARK);
    });
  }

  let obs;
  function ensureObserver(on) {
    if (on && lobs) {
      obs = new MutationObserver(() => hideOnce);
      obs.observe(document.documentElement, {childList: true, subtree: true});
    }
  }

  async function applyFromSettings() {
    const {unAIfySettings} = await storage.get("unAIfySettings");
    const hide = !!(unAIfySettings ? unAIfySettings.hide_sge : true)
    if (hide) {hideOnce(); ensureObserver(true);}
    else {ensureObserver(false); unhideAll();}
  }

  //live toggle
  chrome.stroage.onChanged.addListner((changes, area) => {
    if(area !== "sync") return;
    if("unAIfySettings" in changes) applyFromSettings();
  })

  applyFromSettings();

})();
